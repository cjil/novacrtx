apiVersion: v1
kind: ConfigMap
metadata:
  name: authelia-configfile
  namespace: authelia
data:
  configuration.yaml: |
    regulation:
      find_time: 10m
      ban_time: 12h
    session:
      cookies:
        - domain: ${DOMAIN_0}
          authelia_url: https://auth.${DOMAIN_0}
          default_redirection_url: 'https://www.${DOMAIN_0}'
    password_policy:
      standard:
        enabled: true
        min_length: 10
        max_length: 0
        require_uppercase: true
        require_lowercase: true
        require_number: true
        require_special: true
    access_control:
      default_policy: 'deny'
      rules:
        - domain:
            - ${DOMAIN_0}
            - '*.${DOMAIN_0}'
          policy: one_factor
          subject: 'group:admin'
        - domain:
            - "media.${DOMAIN_0}"
          policy: one_factor
          subject: 'group:arr'
        - domain:
            - "nextcloud.${DOMAIN_0}"
          policy: one_factor
          subject: 'group:nextcloud'
    identity_providers:
      oidc:
        claims_policies:
          grafana:
            id_token: ['email', 'name', 'groups', 'preferred_username']
        hmac_secret: '{{ secret "/config/secret/hmac_secret" }}'
        jwks:
          - key: |
              {{ secret "/config/secret/jwks_key.pem" | mindent 10 "|" | msquote }}
        enable_client_debug_messages: true
        authorization_policies:
          apps:
            default_policy: 'deny'
            rules:
              - policy: 'one_factor'
                subject: 'group:apps'
          grafana:
            default_policy: 'deny'
            rules:
              - policy: 'one_factor'
                subject: 'group:admin'
              - policy: 'one_factor'
                subject: 'group:grafana_admin'
              - policy: 'one_factor'
                subject: 'group:grafana_editor'
              - policy: 'one_factor'
                subject: 'group:grafana_viewer'  
        clients:
          - client_id: 'grafana'
            client_name: 'Grafana'
            claims_policy: 'grafana'
            client_secret: '{{ secret "/config/secret/clients_grafana_client_secret" }}'
            public: false
            authorization_policy: 'grafana'
            require_pkce: true
            pkce_challenge_method: 'S256'
            redirect_uris:
              - 'https://grafana.${DOMAIN_0}/login/generic_oauth'
            scopes:
              - 'openid'
              - 'profile'
              - 'email'
              - 'groups'
            response_types:
              - 'code'
            grant_types:
              - 'authorization_code'
            access_token_signed_response_alg: 'none'
            userinfo_signed_response_alg: 'none'
            token_endpoint_auth_method: 'client_secret_basic'

